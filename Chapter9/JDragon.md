# 09 테스트 속도 개선

테스트 속도 개선이란 테스트를 빠르게 해줄 실마리를 찾기 위해 코드를 파헤치는 작업

## 9.1 속도 개선을 위해서

### 9.1.1 더 빠르게!

개발자는 빌드를 걸어놓고 다른 작업을 시작해야 하는데, 테스트 속도가 느리면 멍~하니 기다려야 한다

### 9.1.2 상황 속으로

성능문제를 겪게 되면 프로파일러의 도움을 구해 병목지점을 찾고 성능 저하의 원인을 파악할 것이다

느린 테스트와 느린 빌드에 대한 접근 방식

- 무엇이 문제라고 미리부터 가정하지 말고 테스트가 어떻게 실행되는지 분석하여 정확한 상황 데이터를 구해야 한다

### 9.1.3 빌드 프로파일링하기

빌드를 느리게 하는 가장 큰 원인은 거~의 언제나 테스트다

메이븐 빌드 프로파일링하기

- 메이븐의 기본 기능만으로는 빌드 단계별 수행 시간을 측정할 수 없다.
- maven-build-utils 익스텐선을 추가해준다
- <build> 와 <properties>, <profiles> 를 추가해준다
- 메이븐에 -P 파라미터로 perfstats 프로파일을 활성화하고 빌드를 하면 된다
- 한 단계가 차지하는 비율, 시간을 구할 수 있다

### 9.1.4 테스트 프로파일링하기

최적화 대상을 테스트로 정했다면 현재 병목구간을 파악해야 한다

메이븐 보고서 생성기 : maven-surefile-plugin 을 사용하면 된다

성능 개선 기법

- 테스트 코드를 최적화하는 묘책과 검토사항
- 빌드 스크립트를 개선해서 추가적인 속도를 이끌어내는 방법

## 9.2 테스트 코드 속도 높이기

테스트 코드 속도 개선의 핵심 전략은 느린 부분을 찾아내어 더 빠르게 만들거나 아예 실행시키지 않는 것

### 9.2.1 피곤하지 않다면 잠들지 말라

테스트를 멈춰있게 하지마라

### 9.2.2 덩치 큰 기반 클래스를 경계하라

- 기반 클래스는 보통 공통의 셋업, 티어다운 메서드, 유틸리티 메서드를 제공한다. 테스트 작성자에겐 편하지만 대가를 치러야 한다. 하위 클래스의 모든 테스트가 이런 유틸 기능을 전부 사용하는 경우가 거의 없다. 쓸데없이 반복 수행되는 요소를 제거하라
- 다른 클래스를 상속하면 그 클래스의 셋업과 티어다운을 매번 실행한다. 쓸데없는 계층을 없애라
- 상속을 코드 재사용의 목적으로 사용하지 말라는 말과 일맥상통?하는건가??
- 테스트가 사용하지 않는 것을 준비하느라 느려지게 하는건 바람직하지 않다

### 9.2.3 불필요한 셋업과 티어다운을 경계하라

- Before 와 After 는 테스트 하나당 한 번씩 실행된다.
- 매번 실행해줘야 하는건지, 한번만 실행해도 되는건지 구분하고 어노테이션을 붙여줘라

### 9.2.4 테스트에 초대할 손님은 까다롭게 선택하라

- 코드 양이 많아질수록 실행 시간이 길어진다
- 테스트를 격리하면 결과에 영향을 주는 변수가 줄어든다. 주변 컴포넌트를 걷어내어 테스트 시간을 단축시키자
- 각 테스트에서 중요하지 않은 부분을 스텁으로 교체함으로써 빌드 시간을 단축시킬 수 있다
- 원격 시스템이나 인터넷을 이용하는 협력 객체를, 로컬 하게 유지해야 한다

### 9.2.5 로컬하게, 그리고 빠르게 유지하라

- 같은 데이터라도 클라우드 서비스에서 가져오려면 지역변수를 읽는 것보다 10만배는 더 걸린다
- 테스트를 가능한 로컬하게 유지하고 네트워크 사용을 배제해야 한다
- 단위테스트에서는 네트워크를 호출하지 말아야 한다

### 9.2.6 데이터베이스의 유혹을 뿌리쳐라

- 데이터베이스 호출을 우회하면 불필요한 네트워크나 파일시스템 접근을 피할 수 있다
- 되도록 테스트 대상 코드와 가까운 협력 객체를 가짜 객체(Fake)로 교체하는 것이 좋다.
- 테스트 대상 코드와 협력 객체 사이에서 일어나는 일만 확인하면 되는것이다!!! 정말 중요
- 협력객체와 또 다른 협력객체 사이에서 일어나는 일은 알 바가 아니다.
- 즉 테스트를 격리, 객체들에게 적절한 책임분배, 적절한 테스트 더블 사용
- 편하게 테스트하고 싶다면 단위 테스트에서 영속 객체를 통째로 스텁으로 교체할 수 있어야한다
- 최선책 : 데이터베이스 사용을 자제해라  , 차선책 : 인메모리 데이터베이스를 사용해라

### 9.2.7 파일 IO 보다 느린 IO 는 없다

- 테스트 코드 파일 접근을 피하라
- 대상 코드의 파일 접근을 가로채라
- 간단한 클래스패스 꼼수로 로깅 끄기
- 로그를 끄는 것 만으로도 속도가 수십퍼센트는 빨라질 수 있다

## 9.3 빌드 속도 높이기

### 9.3.2 빌드 병렬화 하기

- maven-surefile-plugin 에서 threadCount 를 설정해준다
- perCoreThreadCount 를 false 로 하면 코어 개수와 상관없이 스레드의 총 개수를 지정할 수 있다
- 하드디스크의 응답을 기다리며 CPU 가 놀고 있는 시간만큼을 개선할 수 있다
- 테스트를 여러 스레드로 실행한다고 해서 모든 스레드가 동시에 실행되는 것은 아니다. 여러 스레드 사이를 왔다 갔다 하며 실행하게 된다
- 한 테스트 스레드가 디스크IO를 기다리는 동안 CPU 는 다른 스레드의 코드를 실행할 수 있다

### 9.3.3 고성능 CPU 에 짐 떠넘기기

### 9.3.4 빌드 분산하기

빌드 분산 방법?

- 필요한 코드와 데이터 등의 자원을 빌드에 쓰일 원격 컴퓨터로 복제해야 한다
- 해당 컴퓨터에 시작 명령을 전달하고 실행 결과와 로그를 다시 개발자 컴퓨터로 받아올 수단이 필요하다

빌드 : 소스코드를 바이트 코드로 컴파일하고, 테스트를 수행하여 결과를 출력한 후, 전체 테스트 결과를 하나의 보고서로 취합하는 과정

GridGain 을 통한 테스트 분산 실행